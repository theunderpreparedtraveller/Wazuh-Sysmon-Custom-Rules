<group name="powershell">
  <rule id="100200" level="10">
    <if_group>powershell</if_group>
    <field name="win.system.providerName">Microsoft-Windows-PowerShell</field>
    <description>PowerShell ScriptBlock logging detected</description>
  </rule>
  <rule id="95001" level="10">
  <if_group>windows,security_event</if_group>
  <field name="win.system.eventID">4624</field>
  <field name="win.eventdata.LogonType">10</field>
  <description>Successful RDP login detected</description>
  <mitre>
    <id>T1076</id> <!-- Remote Desktop Protocol -->
    <id>T1021</id> <!-- Remote Services -->
  </mitre>
</rule>
<rule id="95002" level="8">
  <if_group>windows,security_event</if_group>
  <field name="win.system.eventID">4625</field>
  <field name="win.eventdata.LogonType">10</field>
  <description>Failed RDP login attempt detected</description>
  <mitre>
    <id>T1076</id>
    <id>T1021</id>
  </mitre>
</rule>

</group>
<group name="sysmon_dns,windows,">
  <!-- Detect suspicious DNS queries from tools like PowerShell, wscript, rundll32 -->
  <rule id="100100" level="10">
    <if_group>sysmon_event22</if_group>
    <field name="win.eventdata.image" type="pcre2">(?i)(powershell\.exe|wscript\.exe|cscript\.exe|rundll32\.exe|cmd\.exe)</field>
    <description>Suspicious process making DNS query</description>
    <mitre>
      <id>T1071.004</id> <!-- MITRE ATT&CK: Application Layer Protocol: DNS -->
    </mitre>
  </rule>

  <!-- Catch all DNS queries (debugging/visibility) -->
  <rule id="100101" level="3">
    <if_group>sysmon_event22</if_group>
    <description>DNS query detected (Sysmon Event ID 22)</description>
  </rule>
</group>
